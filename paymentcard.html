<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Theatrum — Payment</title>
  <link rel="stylesheet" href="styles/index_styles.css" />
  <style>
    .checkout-shell {
      max-width: 1200px;
      margin: 120px auto 64px;
      padding: 0 32px;
    }
    .payment-layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(260px, 1.2fr);
      gap: 24px;
    }
    @media (max-width: 900px) {
      .payment-layout {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
    }
    .card h2 {
      font-size: 26px;
      margin-bottom: 8px;
    }
    .muted {
      color: var(--text-secondary);
      font-size: 14px;
    }
    .divider {
      height: 1px;
      background: var(--border);
      margin: 16px 0 20px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .pill.step-pill {
      background: rgba(96, 165, 250, 0.1);
      border-color: rgba(96, 165, 250, 0.3);
      color: #60a5fa;
    }

    /* Left column: payment card + form */
    .card-preview {
      border-radius: 16px;
      padding: 18px 18px 20px;
      background: radial-gradient(circle at top left, rgba(248, 113, 113, 0.35), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(56, 189, 248, 0.4), transparent 55%),
                  #020617;
      color: #e5e7eb;
      box-shadow: 0 22px 45px rgba(15, 23, 42, 0.65);
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 150px;
    }
    .card-preview-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      opacity: 0.9;
    }
    .card-brand {
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }
    .card-chip {
      width: 30px;
      height: 22px;
      border-radius: 6px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }
    .card-preview-number {
      font-size: 18px;
      letter-spacing: 0.14em;
      margin: 18px 0 8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .card-preview-bottom {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .card-holder-label,
    .card-exp-label {
      opacity: 0.7;
      margin-bottom: 2px;
    }
    .card-holder-value,
    .card-exp-value {
      font-size: 12px;
      font-weight: 500;
    }
    .card-placeholder {
      font-size: 12px;
      opacity: 0.75;
      margin-top: 6px;
    }

    .payment-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
      margin-bottom: 10px;
    }

    .card-form {
      margin-top: 8px;
      border-radius: 12px;
      border: 1px dashed var(--border);
      padding: 16px;
      display: none; /* initially hidden */
    }
    .card-form-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .card-form-group {
      margin-bottom: 12px;
    }
    .card-form-group label {
      display: block;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    .card-form-group input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 13px;
    }
    .card-form-group input:focus {
      outline: none;
      border-color: rgba(59, 130, 246, 0.7);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.4);
    }

    .pay-btn-wrapper {
      margin-top: 12px;
    }

    /* Right column: order summary */
    .sidebar-heading {
      font-size: 18px;
      margin-bottom: 6px;
    }
    .sidebar-section {
      margin-bottom: 16px;
    }
    .sidebar-section:last-child {
      margin-bottom: 0;
    }
    .sidebar-label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 2px;
    }
    .sidebar-value {
      font-size: 14px;
      color: var(--text-primary);
      font-weight: 500;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      font-size: 14px;
    }
    .summary-row span:last-child {
      font-weight: 600;
    }
    .tax-note {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="logo" id="logo">
        <span class="logo-thea">THEA</span><span class="logo-trum">TRUM</span>
      </div>
      <ul class="nav-links">
        <li><a href="#now-playing">Now Playing</a></li>
        <li><a href="#coming-soon">Coming Soon</a></li>
        <li><a href="#concessions">Food & Drinks</a></li>
        <li><a href="#offers">Offers</a></li>
        <li><a href="#locations">Locations</a></li>
      </ul>
      <div class="nav-actions">
        <div class="search-box">
          <input id="globalSearch" type="text" placeholder="Search movies..." />
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </div>
        <button id="userButton" class="btn-primary">Alex</button>
      </div>
    </div>
  </nav>

  <main class="checkout-shell">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:20px;">
      <!-- Step label -->
      <span class="pill step-pill">Step 4 — Payment</span>
      <span class="muted">Final step — choose a payment method and confirm your booking.</span>
    </div>

    <div class="payment-layout">
      <!-- Left: card + form -->
      <section class="card">
        <h2>Payment method</h2>
        <p class="muted">
          Securely pay for your tickets and snacks. Your card won’t be charged until you confirm.
        </p>
        <div class="divider"></div>

        <!-- Card preview -->
        <div class="card-preview" id="card-preview">
          <div class="card-preview-top">
            <span class="card-brand">Theatrum</span>
            <div class="card-chip">••</div>
          </div>
          <div class="card-preview-number" id="preview-number">
            •••• •••• •••• ••••
          </div>
          <div class="card-preview-bottom">
            <div>
              <div class="card-holder-label">Cardholder</div>
              <div class="card-holder-value" id="preview-name">
                No card added
              </div>
            </div>
            <div>
              <div class="card-exp-label">Expires</div>
              <div class="card-exp-value" id="preview-exp">
                -- / --
              </div>
            </div>
          </div>
          <div class="card-placeholder" id="card-placeholder">
            Choose a payment option to enter your details.
          </div>
        </div>

        <div class="payment-actions">
          <button class="btn-secondary" id="add-card-btn">
            Add card
          </button>
          <button class="btn-secondary" id="apple-pay-btn">
             Apple Pay
          </button>
          <button class="btn-secondary" id="google-pay-btn">
            G Pay
          </button>
        </div>

        <!-- Hidden card form (shown after clicking Add card / Apple / Google) -->
        <form class="card-form" id="card-form" novalidate>
          <div class="card-form-group">
            <label for="card-name">Name on card</label>
            <input type="text" id="card-name" autocomplete="cc-name" />
          </div>
          <div class="card-form-group">
            <label for="card-number">Card number</label>
            <input type="text" id="card-number" maxlength="19" placeholder="1234 5678 9012 3456" autocomplete="cc-number" />
          </div>
          <div class="card-form-row">
            <div class="card-form-group">
              <label for="card-exp">Expiry (MM/YY)</label>
              <input type="text" id="card-exp" maxlength="5" placeholder="MM/YY" autocomplete="cc-exp" />
            </div>
            <div class="card-form-group">
              <label for="card-cvv">CVV</label>
              <input type="password" id="card-cvv" maxlength="4" autocomplete="cc-csc" />
            </div>
          </div>
          <div class="card-form-group">
            <label for="card-postal">Postal code</label>
            <input type="text" id="card-postal" autocomplete="postal-code" />
          </div>

          <div class="pay-btn-wrapper">
            <button type="button" class="btn-primary" id="pay-now-btn">
              Pay now
            </button>
            <p class="tax-note">By tapping “Pay now”, you agree to Theatrum’s terms and privacy policy.</p>
          </div>
        </form>
      </section>

      <!-- Right: order summary -->
      <aside class="card">
        <h3 class="sidebar-heading">Order summary</h3>

        <div class="sidebar-section">
          <div class="sidebar-label">Tickets</div>
          <div class="sidebar-value" id="summary-tickets-line">0 × Standard</div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-label">Seats</div>
          <div class="sidebar-value" id="summary-seats">None selected</div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-label">Snacks & extras</div>
          <div class="sidebar-value" id="summary-snacks">No add-ons</div>
        </div>

        <div class="divider"></div>

        <div class="summary-row">
          <span>Subtotal</span>
          <span id="summary-subtotal">$0.00</span>
        </div>
        <div class="summary-row">
          <span>Estimated tax & fees</span>
          <span id="summary-fees">$0.00</span>
        </div>
        <div class="summary-row" style="margin-top: 10px; font-size: 16px;">
          <span>Total due</span>
          <span id="summary-total">$0.00</span>
        </div>
        <p class="tax-note">
          Exact tax and fees may vary slightly based on your payment provider.
        </p>
      </aside>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <div class="footer-logo">
            <span class="logo-thea">THEA</span><span class="logo-trum">TRUM</span>
          </div>
          <p>Experience cinema the way it was meant to be seen.</p>
        </div>
        <div class="footer-section">
          <h4>Customer Support</h4>
          <ul>
            <li><a href="#">Help Center</a></li>
            <li><a href="#">Contact Us</a></li>
            <li><a href="#">Accessibility</a></li>
            <li><a href="#">Careers</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>Newsletter</h4>
          <p>Get the latest movies and exclusive offers</p>
          <div class="newsletter-form">
            <input type="email" placeholder="Your email" />
            <button class="btn-primary">Subscribe</button>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 THEATRUM. All rights reserved.</p>
        <div class="footer-links">
          <a href="#">Privacy Policy</a>
          <a href="#">Terms of Service</a>
          <a href="#">Cookie Settings</a>
        </div>
      </div>
    </div>
  </footer>

  <script src="scripts/booking.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      function safeInt(v) {
        var n = parseInt(v, 10);
        return isNaN(n) ? 0 : n;
      }
      function safeFloat(v, fallback) {
        var n = parseFloat(v);
        return isNaN(n) ? (fallback || 0) : n;
      }
      function notify(message, type) {
        if (typeof showToast === 'function') {
          showToast(message, type || 'info');
        } else {
          alert(message);
        }
      }

      // Load booking data
      var ticketQty = safeInt(localStorage.getItem('ticketQty'));
      var ticketType = localStorage.getItem('ticketType') || 'standard';
      var ticketUnitPrice = safeFloat(localStorage.getItem('ticketUnitPrice'), 12.0);

      var seats = [];
      try {
        seats = JSON.parse(localStorage.getItem('selectedSeats') || '[]');
      } catch (e) {
        seats = [];
      }

      var foodOrder = {};
      if (typeof getNormalizedFoodOrder === 'function') {
        foodOrder = getNormalizedFoodOrder();
      } else {
        try {
          foodOrder = JSON.parse(localStorage.getItem('foodOrder') || '{}');
        } catch (e) {
          foodOrder = {};
        }
      }

      var upsellCart = [];
      try {
        upsellCart = JSON.parse(localStorage.getItem('upsellCart') || '[]');
      } catch (e) {
        upsellCart = [];
      }

      // ---- Calculate totals ----
      var typeKey = (ticketType || 'standard').toLowerCase();
      var typeLabels = {
        standard: 'Standard',
        '3d': '3D',
        imax: 'IMAX',
        dolby: 'Dolby Cinema'
      };
      var ticketLabelType = typeLabels[typeKey] || 'Standard';

      var ticketSubtotal = ticketQty * ticketUnitPrice;

      var snacksTotal = 0;
      var hasSnacksOrExtras = false;
      Object.keys(foodOrder || {}).forEach(function (k) {
        var it = foodOrder[k];
        if (!it) return;
        var qty = safeInt(it.qty);
        var unitPrice = safeFloat(it.price, 0);
        if (qty <= 0) return;
        snacksTotal += qty * unitPrice;
        hasSnacksOrExtras = true;
      });

      var upsellTotal = 0;
      if (Array.isArray(upsellCart)) {
        upsellCart.forEach(function (u) {
          upsellTotal += safeFloat(u.price, 0);
          hasSnacksOrExtras = true;
        });
      }

      var subtotal = ticketSubtotal + snacksTotal + upsellTotal;
      var estimatedFees = subtotal * 0.08; // simple 8% estimate
      var totalDue = subtotal + estimatedFees;

      // ---- Fill summary on the right ----
      var summaryTicketsLine = document.getElementById('summary-tickets-line');
      var summarySeatsEl = document.getElementById('summary-seats');
      var summarySnacksEl = document.getElementById('summary-snacks');
      var summarySubtotal = document.getElementById('summary-subtotal');
      var summaryFees = document.getElementById('summary-fees');
      var summaryTotal = document.getElementById('summary-total');

      if (summaryTicketsLine) {
        summaryTicketsLine.textContent =
          ticketQty +
          ' × ' +
          ticketLabelType +
          ' ticket' +
          (ticketQty === 1 ? '' : 's');
      }
      if (summarySeatsEl) {
        summarySeatsEl.textContent = seats && seats.length ? seats.join(', ') : 'None selected';
      }
      if (summarySnacksEl) {
        summarySnacksEl.textContent = hasSnacksOrExtras ? 'Included' : 'No add-ons';
      }
      if (summarySubtotal) summarySubtotal.textContent = '$' + subtotal.toFixed(2);
      if (summaryFees) summaryFees.textContent = '$' + estimatedFees.toFixed(2);
      if (summaryTotal) summaryTotal.textContent = '$' + totalDue.toFixed(2);

      // ---- Card UI + form behaviour ----
      var addCardBtn = document.getElementById('add-card-btn');
      var applePayBtn = document.getElementById('apple-pay-btn');
      var googlePayBtn = document.getElementById('google-pay-btn');

      var cardForm = document.getElementById('card-form');
      var payNowBtn = document.getElementById('pay-now-btn');

      var cardNameInput = document.getElementById('card-name');
      var cardNumberInput = document.getElementById('card-number');
      var cardExpInput = document.getElementById('card-exp');
      var cardCvvInput = document.getElementById('card-cvv');
      var cardPostalInput = document.getElementById('card-postal');

      var previewName = document.getElementById('preview-name');
      var previewNumber = document.getElementById('preview-number');
      var previewExp = document.getElementById('preview-exp');
      var cardPlaceholder = document.getElementById('card-placeholder');

      var cardFormVisible = false;
      var paymentMethod = 'card'; // 'card' | 'applePay' | 'googlePay'

      function formatCardNumber(value) {
        return value
          .replace(/\D/g, '')
          .slice(0, 16)
          .replace(/(.{4})/g, '$1 ')
          .trim();
      }

      function formatExp(value) {
        var digits = value.replace(/\D/g, '').slice(0, 4);
        if (digits.length <= 2) return digits;
        return digits.slice(0, 2) + '/' + digits.slice(2);
      }

      function ensureFormVisible() {
        if (!cardFormVisible) {
          cardFormVisible = true;
          cardForm.style.display = 'block';
          if (addCardBtn) addCardBtn.textContent = 'Hide card details';
          cardPlaceholder.textContent = 'Fill in your details below to save this card for this purchase.';
        }
      }

      if (addCardBtn) {
        addCardBtn.addEventListener('click', function () {
          cardFormVisible = !cardFormVisible;
          cardForm.style.display = cardFormVisible ? 'block' : 'none';
          addCardBtn.textContent = cardFormVisible ? 'Hide card details' : 'Add card';

          if (cardFormVisible) {
            cardPlaceholder.textContent = 'Fill in your details below to save this card for this purchase.';
          } else {
            cardPlaceholder.textContent = 'Choose a payment option to enter your details.';
          }
          paymentMethod = 'card';
        });
      }

      function getUserName() {
        var btn = document.getElementById('userButton');
        var name = btn ? (btn.textContent || btn.innerText || '').trim() : '';
        return name || 'Guest';
      }

      if (applePayBtn) {
        applePayBtn.addEventListener('click', function () {
          paymentMethod = 'applePay';
          ensureFormVisible();

          var name = getUserName() + ' (Apple Pay)';
          if (cardNameInput) {
            cardNameInput.value = name;
            previewName.textContent = name;
          }

          if (cardNumberInput) {
            cardNumberInput.value = '4242 4242 4242 4242';
            cardNumberInput.dispatchEvent(new Event('input'));
          }

          if (cardExpInput) {
            cardExpInput.value = '12/28';
            cardExpInput.dispatchEvent(new Event('input'));
          }

          if (cardCvvInput) {
            cardCvvInput.value = '123';
          }
          if (cardPostalInput) {
            cardPostalInput.value = 'T2A 7V2';
          }

          notify('Apple Pay details added. Review and tap "Pay now".', 'success');
        });
      }

      if (googlePayBtn) {
        googlePayBtn.addEventListener('click', function () {
          paymentMethod = 'googlePay';
          ensureFormVisible();

          var name = getUserName() + ' (Google Pay)';
          if (cardNameInput) {
            cardNameInput.value = name;
            previewName.textContent = name;
          }

          if (cardNumberInput) {
            cardNumberInput.value = '5555 5555 5555 4444';
            cardNumberInput.dispatchEvent(new Event('input'));
          }

          if (cardExpInput) {
            cardExpInput.value = '11/27';
            cardExpInput.dispatchEvent(new Event('input'));
          }

          if (cardCvvInput) {
            cardCvvInput.value = '456';
          }
          if (cardPostalInput) {
            cardPostalInput.value = 'T2A 7V2';
          }

          notify('Google Pay details added. Review and tap "Pay now".', 'success');
        });
      }

      // Live preview updates
      if (cardNameInput) {
        cardNameInput.addEventListener('input', function () {
          previewName.textContent = cardNameInput.value.trim() || 'No card added';
        });
      }
      if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function () {
          var formatted = formatCardNumber(cardNumberInput.value);
          cardNumberInput.value = formatted;
          previewNumber.textContent = formatted || '•••• •••• •••• ••••';
        });
      }
      if (cardExpInput) {
        cardExpInput.addEventListener('input', function () {
          var formatted = formatExp(cardExpInput.value);
          cardExpInput.value = formatted;
          previewExp.textContent = formatted || '-- / --';
        });
      }

      function completePayment() {
        var userName = getUserName();
        var emailSlug = userName.toLowerCase().replace(/\s+/g, '.');
        var email = emailSlug ? emailSlug + '@example.com' : 'guest@example.com';
        var orderId = 'TH-' + Math.floor(100000 + Math.random() * 900000);

        var confirmation = {
          method: paymentMethod,
          customerName: userName,
          email: email,
          orderId: orderId,
          ticketQty: ticketQty,
          ticketType: ticketLabelType,
          ticketUnitPrice: ticketUnitPrice,
          seats: seats,
          snacksTotal: snacksTotal,
          upsellTotal: upsellTotal,
          subtotal: subtotal,
          fees: estimatedFees,
          total: totalDue,
          createdAt: new Date().toISOString()
        };
        try {
          var rawShow = localStorage.getItem('currentShow');
          if (rawShow) {
            var show = JSON.parse(rawShow);
            if (show.movie) confirmation.movie = show.movie;
            if (show.date) confirmation.showDate = show.date;
            if (show.time) confirmation.showTime = show.time;
            if (show.format) confirmation.formatLabel = show.format;
          }
        } catch (err) {
          console.warn('Could not attach currentShow to orderConfirmation', err);
        }

        localStorage.setItem('orderConfirmation', JSON.stringify(confirmation));

        // Clear booking-specific state (we keep orderConfirmation)
        localStorage.removeItem('ticketQty');
        localStorage.removeItem('ticketType');
        localStorage.removeItem('ticketUnitPrice');
        localStorage.removeItem('selectedSeats');
        localStorage.removeItem('foodOrder');
        localStorage.removeItem('upsellCart');

        notify('Payment successful! Redirecting to your tickets…', 'success');
        setTimeout(function () {
          window.location.href = 'thanks.html';
        }, 800);
      }

      if (payNowBtn) {
        payNowBtn.addEventListener('click', function () {
          if (!cardFormVisible) {
            notify('Please add a card before paying.', 'error');
            ensureFormVisible();
            return;
          }

          var name = cardNameInput.value.trim();
          var number = cardNumberInput.value.replace(/\s+/g, '');
          var exp = cardExpInput.value.trim();
          var cvv = cardCvvInput.value.trim();
          var postal = cardPostalInput.value.trim();

          if (!name || !number || !exp || !cvv || !postal) {
            notify('Please fill in all card details.', 'error');
            return;
          }
          if (number.length < 12) {
            notify('Please enter a valid card number.', 'error');
            return;
          }
          if (!/^\d{2}\/\d{2}$/.test(exp)) {
            notify('Please enter a valid expiry in MM/YY format.', 'error');
            return;
          }
          if (cvv.length < 3) {
            notify('Please enter a valid CVV.', 'error');
            return;
          }

          completePayment();
        });
      }
    });
  </script>
</body>
</html>
